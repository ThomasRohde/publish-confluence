Okay, here is a detailed implementation specification for the `confluence-mermaid` Handlebars helper.

## 1. Feature: `confluence-mermaid` Handlebars Helper

Implement a Handlebars block helper named `confluence-mermaid` for the `publish-confluence` tool. This helper will allow users to embed Mermaid.js diagrams directly within their Confluence page templates. The helper will automatically handle attaching the Mermaid.js library to the Confluence page and generate the necessary Confluence Storage Format (XHTML) for an HTML macro to render the diagram.

## 2. Motivation

Mermaid.js is a popular Javascript library for generating diagrams (flowcharts, sequence diagrams, Gantt charts, etc.) from text in a Markdown-like syntax. Enabling direct embedding of these diagrams within Confluence pages generated by `publish-confluence` enhances documentation and visualization capabilities without requiring users to manually manage the Mermaid library or complex macro configurations. This simplifies the workflow for users who want to include generated diagrams alongside their published applications or documentation.

## 3. Goals

*   Add `mermaid` as a `devDependency` to the `publish-confluence` project.
*   Implement a Handlebars block helper `{{#confluence-mermaid}} ... {{/confluence-mermaid}}`.
*   The content within the helper block will be the raw Mermaid diagram definition.
*   The helper must locate the `mermaid.min.js` file from the installed `node_modules`.
*   The helper must signal to the `Publisher` that `mermaid.min.js` needs to be attached to the Confluence page.
*   The helper must generate the Confluence Storage Format for an HTML macro.
*   The generated HTML macro must contain:
    *   The raw Mermaid definition within a `<pre class="mermaid">` tag.
    *   A `<script>` tag referencing the *attached* `mermaid.min.js` file using a relative path suitable for Confluence attachments.
    *   An inline `<script>` block to initialize Mermaid.js (`mermaid.initialize(...)`) and render the diagram (`mermaid.run()`).
*   The standard `{{{scripts}}}` helper should *not* be required within the `confluence-mermaid` block for the Mermaid library itself.
*   Update documentation (`README.md`, relevant docs pages) to explain the usage of the new helper.

## 4. Non-Goals

*   Supporting Mermaid versions other than the one installed as a dev dependency.
*   Implementing sophisticated error handling for invalid Mermaid syntax within the Confluence page (basic errors might be logged to the browser console by Mermaid itself).

## 5. Proposed Implementation

### 5.1. Dependency Management

1.  **Add Mermaid Dependency:**
    *   Modify `package.json` in the `thomasrohde-publish-confluence` root directory.
    *   Add `mermaid` to `devDependencies`.
        ```json
        {
          // ... other properties
          "devDependencies": {
            // ... other dev dependencies
            "mermaid": "^10.x.x" // Use the latest stable v10.x or newer
          }
        }
        ```
    *   Run `npm install` to install the new dependency.

### 5.2. File Modifications

1.  **`src/macro-helpers.ts`:**
    *   Define the `confluenceMermaidHelper` function.
    *   Register the helper with Handlebars using `Handlebars.registerHelper('confluence-mermaid', confluenceMermaidHelper);`.
    *   Import necessary modules (`fs`, `path`, `require`).

2.  **`src/publisher.ts`:**
    *   Modify the `Publisher` class or related functions to handle the special attachment request for `mermaid.min.js`.
    *   Ensure `mermaid.min.js` is included in the list of files to be uploaded if the `confluence-mermaid` helper is used in the template.
    *   Potentially modify the template compilation context or process if needed to resolve the relative path `mermaid.min.js` correctly, although Confluence HTML macros usually handle relative paths to attachments well.

3.  **`src/types.ts` (Potentially):**
    *   If the helper signals attachment needs via metadata, define the structure for this metadata. (Alternative: modify Publisher to scan template output for specific patterns or manage a shared list).

4.  **`README.md` & `docs/child-pages/page-4.html`:**
    *   Add documentation for the `{{#confluence-mermaid}}` helper, including syntax and an example.

### 5.3. `confluenceMermaidHelper` Implementation (`src/macro-helpers.ts`)

```typescript
import * as Handlebars from 'handlebars';
import * as fs from 'fs';
import * as path from 'path';
import { logger } from './logger'; // Assuming logger exists

// Interface to track required static assets (like mermaid.js)
interface HelperAttachmentRequirements {
  requiredFiles?: Set<string>; // Set of absolute paths to files needed by helpers
}

// Function to locate mermaid.min.js
let mermaidJsPath: string | null = null;
function findMermaidJs(): string | null {
  if (mermaidJsPath === null) {
    try {
      // Use require.resolve to find the package entry point, then navigate to dist
      // This is more robust than hardcoding node_modules path
      const mermaidPackagePath = path.dirname(require.resolve('mermaid/package.json'));
      const potentialPath = path.join(mermaidPackagePath, 'dist', 'mermaid.min.js');
      if (fs.existsSync(potentialPath)) {
        mermaidJsPath = potentialPath;
         logger.debug(`Found mermaid.min.js at: ${mermaidJsPath}`);
      } else {
         logger.error(`mermaid.min.js not found at expected path: ${potentialPath}`);
         mermaidJsPath = 'NOT_FOUND'; // Mark as checked but not found
      }
    } catch (error) {
      logger.error('Error resolving mermaid package path:', error);
      mermaidJsPath = 'NOT_FOUND';
    }
  }
  return mermaidJsPath === 'NOT_FOUND' ? null : mermaidJsPath;
}


export function registerMacroHelpers(context?: any): void {
  // ... other helper registrations ...

  Handlebars.registerHelper('confluence-mermaid', function(options: Handlebars.HelperOptions) {
    const mermaidDefinition = options.fn(this); // Get content inside the block
    const uniqueId = `mermaid-diagram-${Date.now()}-${Math.random().toString(16).substring(2, 8)}`;

    // --- Attachment Signaling ---
    const mermaidPath = findMermaidJs();
    if (!mermaidPath) {
       return new Handlebars.SafeString(
        `<div style="border: 1px solid red; padding: 10px; color: red;">
          Error: Could not find mermaid.min.js library. Please ensure 'mermaid' is installed as a devDependency.
         </div>`
      );
    }
    // Signal the Publisher to attach this file.
    // This requires the Publisher to collect these requirements.
    // We'll add it to a shared context or a dedicated collection mechanism.
    // Assuming a context object passed during template compilation:
    if (context && context.attachmentRequirements) {
        if (!context.attachmentRequirements.requiredFiles) {
            context.attachmentRequirements.requiredFiles = new Set<string>();
        }
        context.attachmentRequirements.requiredFiles.add(mermaidPath);
        logger.debug(`Signaled requirement for attachment: ${mermaidPath}`);
    } else {
        logger.warn('Attachment requirements context not available for confluence-mermaid helper. Mermaid JS might not be attached.');
        // Fallback or alternative signaling might be needed depending on Publisher design
    }

    // Escape the Mermaid definition for safe embedding within CDATA and HTML
    // Basic escaping for </script> which could break the inline script
    const escapedDefinition = mermaidDefinition
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/&/g, '&amp;'); // Basic XML escaping needed within CDATA sometimes, belt-and-braces.

    // Generate Confluence Storage Format (XHTML) for the HTML macro
    const macroXHTML = `
<ac:structured-macro ac:name="html" ac:schema-version="1">
  <ac:plain-text-body><![CDATA[
    <div class="mermaid-container" id="${uniqueId}-container">
      <pre class="mermaid">
        ${escapedDefinition.trim()}
      </pre>
      <script src="mermaid.min.js"></script> <!-- Relative path to attached file -->
      <script>
        try {
          // Initialize Mermaid - important: startOnLoad: false as we call run explicitly
          mermaid.initialize({
            startOnLoad: false,
            theme: 'default', // Or 'base', 'forest', 'dark', 'neutral'
            // Add any other desired default configurations here
            // e.g., securityLevel: 'strict',
            logLevel: 'warn' // Set log level (debug, info, warn, error, fatal)
          });
          // Explicitly render the diagrams within this macro instance
          mermaid.run({
             querySelector: '#${uniqueId}-container .mermaid',
             suppressErrors: false // Set to true to hide errors on page
           });
          console.log('Mermaid diagram (${uniqueId}) initialized and run.');
        } catch (e) {
          console.error('Error initializing or running Mermaid diagram (${uniqueId}):', e);
          // Optionally display an error message in the container
          var container = document.getElementById('${uniqueId}-container');
          if (container) {
            container.innerHTML = '<p style="color: red;">Error rendering Mermaid diagram. Check browser console.</p><pre>' + ${JSON.stringify(escapedDefinition.trim())} + '</pre>';
          }
        }
      </script>
    </div>
  ]]></ac:plain-text-body>
</ac:structured-macro>
    `;

    return new Handlebars.SafeString(macroXHTML.trim());
  });

  // ... other helper registrations ...
}

// Ensure the context type is updated if needed (in types.ts or publisher.ts)
export interface TemplateCompilationContext extends HelperAttachmentRequirements {
    pageTitle?: string;
    currentDate?: string;
    // ... other potential context properties
}

```

### 5.4. Publisher Modifications (`src/publisher.ts`)

1.  **Collect Attachment Requirements:**
    *   Before compiling the *page* template, initialize a `TemplateCompilationContext` object.
        ```typescript
        const compilationContext: TemplateCompilationContext = {
            pageTitle: this.config.pageTitle,
            currentDate: new Date().toISOString().split('T')[0],
            attachmentRequirements: { requiredFiles: new Set<string>() }
        };
        ```
    *   Pass this `compilationContext` to the `Handlebars.compile(pageTemplateContent)(compilationContext)` call (or wherever the page template is rendered).
    *   *After* rendering the page template, inspect `compilationContext.attachmentRequirements.requiredFiles`.

2.  **Find and Prepare Attachments:**
    *   Modify the `findFilesToAttach` method (or equivalent logic) to include the files specified in `compilationContext.attachmentRequirements.requiredFiles`.
    *   These files need to be added to the list of assets to upload. Ensure they are treated correctly regarding relative paths and base names for the attachment process. The key is that the `mermaid.min.js` file from the set should be uploaded with the filename `mermaid.min.js`.
        ```typescript
        // Inside Publisher or related logic
        const filesFromDist = await this.findFilesToAttach(); // Existing logic
        const requiredHelperFiles = Array.from(compilationContext.attachmentRequirements.requiredFiles || []);

        const allFilesToAttach = [...filesFromDist];

        for (const helperFilePath of requiredHelperFiles) {
            // Avoid duplicates if somehow already included
            if (!allFilesToAttach.some(f => path.basename(f.absolutePath) === path.basename(helperFilePath))) {
                 allFilesToAttach.push({
                    absolutePath: helperFilePath,
                    relativePath: path.basename(helperFilePath) // Use basename for attachment name
                 });
                 logger.verbose(`Adding required helper file to attachments: ${path.basename(helperFilePath)}`);
            }
        }
        // Now use allFilesToAttach for the upload process...
        ```

3.  **Upload Attachments:**
    *   The existing attachment upload logic in `ConfluenceClient` should work, provided it receives the correct file path and desired attachment name (`mermaid.min.js`). No major changes should be needed here unless the upload logic relies heavily on the `distDir`.

4.  **Macro Rendering:**
    *   The `confluence-mermaid` helper already generates the macro XHTML with the relative `<script src="mermaid.min.js"></script>`. The `Publisher`'s main role here is ensuring the file *is actually attached* with that name. The Confluence HTML macro runtime usually resolves relative `src` attributes to attachments on the current page.

### 5.5. Data Structures (`src/types.ts`)

```typescript
// Add or modify existing types if needed
export interface HelperAttachmentRequirements {
  requiredFiles?: Set<string>; // Absolute paths to files required by helpers
}

export interface TemplateCompilationContext extends HelperAttachmentRequirements {
  pageTitle?: string;
  currentDate?: string;
  macro?: string; // Existing variable for the main HTML macro
  // Potentially add lists of attached script/style files if needed elsewhere
  // attachedScripts?: { name: string; url: string }[];
  // attachedStyles?: { name: string; url: string }[];
}

export interface FileToAttach {
    absolutePath: string;
    relativePath: string; // Path relative to distDir OR just the basename for required files
}
```

## 6. Error Handling

*   If `mermaid.min.js` cannot be found via `require.resolve`, the helper will log an error and render an error message directly into the Confluence page content instead of the macro.
*   If the `attachmentRequirements` context is not available when the helper runs (indicating a potential issue in the `Publisher` setup), a warning will be logged.
*   Errors during the attachment upload process will be handled by the existing `ConfluenceClient` error handling.
*   JavaScript errors during Mermaid initialization or rendering *on the Confluence page* will be logged to the browser's console and may optionally display an error message within the diagram container, as configured in the inline script.

## 7. Security Considerations

*   The Mermaid definition content comes directly from the Handlebars template. As Handlebars templates are controlled by the user running `publish-confluence`, the primary risk is self-inflicted.
*   The helper performs basic escaping (`<`, `>`, `&`) on the definition before placing it in the `<pre>` tag and the inline script's JSON stringify. This helps prevent accidental breakage of the surrounding HTML/XML/JS structure.
*   Mermaid.js itself has security configurations (e.g., `securityLevel`). The default initialization script sets a reasonable default (`warn` log level). Users concerned about complex diagrams potentially executing unintended code (highly unlikely with standard Mermaid) should be aware of Mermaid's own security documentation.

## 8. Documentation (`README.md` / `docs/child-pages/page-4.html`)

Add a new section for the `confluence-mermaid` helper:

```markdown
### Mermaid Diagram Macro

Renders diagrams from Mermaid syntax. Automatically attaches the required `mermaid.js` library.

**Usage:**

```handlebars
\{{#confluence-mermaid}}
graph TD;
    A-->B;
    A-->C;
    B-->D;
    C-->D;
\{{/confluence-mermaid}}

sequenceDiagram
    participant Alice
    participant Bob
    Alice->>John: Hello John, how are you?
    loop Healthcheck
        John->>John: Fight against hypochondria
    end
    Note right of John: Rational thoughts <br/>prevail...
    John-->>Alice: Great!
    John->>Bob: How about you?
    Bob-->>John: Jolly good!
```

**Details:**

*   Place your Mermaid diagram definition between the opening and closing helper tags.
*   The `mermaid.js` library (v10.x or the version specified in `devDependencies`) will be automatically attached to the page.
*   This helper generates a Confluence HTML macro containing the diagram definition and the necessary scripts to render it.
*   You do **not** need to include `{{{scripts}}}` within this block for Mermaid itself.
*   Ensure `mermaid` is listed in the `devDependencies` of your `publish-confluence` installation or project.
```

## 9. Future Considerations

*   Allow passing basic configuration options to `mermaid.initialize` via helper arguments (e.g., `{{#confluence-mermaid theme="dark"}}`).
*   Add better error reporting within the generated macro if Mermaid syntax is invalid.
*   Allow specifying a custom path or URL for the Mermaid library instead of relying solely on the attached version.