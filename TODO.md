
# Enhancements for Confluence Server API Interaction and Publishing Flow

## Introduction

This document outlines a series of tasks to improve the `publish-confluence` tool, focusing on enhancing its interaction with the Confluence Server REST API and refining the overall publishing workflow. The goal is to make the tool more robust, efficient, and feature-rich for users publishing content to Confluence Server instances.

## I. Confluence API Client Enhancements (`src/client.ts`)

### 1.1. Implement Page Label Management
    - **Description**: Add functionality to manage labels (tags) on Confluence pages.
    - **Rationale**: Labels are crucial for organizing and searching content in Confluence.
    - **Tasks**:
        1. Research Confluence Server REST API endpoints for:
            - Getting labels for a page (e.g., `GET /rest/api/content/{id}/label`).
            - Adding labels to a page (e.g., `POST /rest/api/content/{id}/label`).
            - Removing labels from a page (e.g., `DELETE /rest/api/content/{id}/label/{labelName}`).

        2. Implement methods in `ConfluenceClient` (e.g., `getPageLabels`, `addLabelsToPage`, `removeLabelFromPage`, `setPageLabels`).
        3. Update `Publisher` to use these methods based on new configuration options (e.g., `labels: ["label1", "label2"]` in `publish-confluence.json`).

    - **Relevant Files**: `src/client.ts`, `src/publisher.ts`, `src/types.ts`

### 1.2. Enhance API Error Handling and Resilience
    - **Description**: Make error handling more specific to Confluence Server API responses and improve retry mechanisms, especially for rate limiting.
    - **Rationale**: Increases robustness and provides better feedback to users. Confluence Server instances might have configurable rate limits or be under heavy load.
    - **Tasks**:
        1. Review Confluence Server API error codes (e.g., 400, 401, 403, 404, 405, 429, 500, 503) and typical response bodies. 
        2. Extend `ConfluenceError` in `src/errors.ts` to include more specific error types or codes (e.g., `RateLimitError`, `AuthenticationError`, `PermissionError`, `ResourceNotFoundError`).
    - **Relevant Files**: `src/client.ts`, `src/errors.ts`, `src/fetch.ts`

## II. Publishing Workflow Enhancements (`src/publisher.ts` and CLI)

### 2.1. Implement Dry Run Mode
    - **Description**: Add a `--dry-run` CLI flag to simulate the publishing process without making any actual changes to Confluence.
    - **Rationale**: Allows users to verify configuration and intended changes before committing them.
    - **Tasks**:
        1. Add a `--dry-run` option to the CLI in `src/cli.ts`.
        2. Pass the dry run status through the `Publisher` to the `ConfluenceClient`.
        3. In `ConfluenceClient` methods that perform write operations (create, update, delete), check for dry run mode.
        4. If dry run mode is active, log the intended action (e.g., "DRY RUN: Would create page 'Title' in space 'KEY'") instead of making the API call. Return a simulated successful response structure where necessary for the publisher flow to continue.
        5. Ensure all operations (page creation/update, attachment upload/delete/update, label changes, content property changes) respect dry run mode.
    - **Relevant Files**: `src/cli.ts`, `src/publisher.ts`, `src/client.ts`

### 2.2. Add Template Validation
    - **Description**: Implement a step to validate Handlebars templates and the generated XHTML against Confluence storage format rules before attempting to publish.
    - **Rationale**: Catches common template errors early and prevents failed API calls or malformed pages. This is a TODO item in `README.md`.
    - **Tasks**:
        1. Research or identify a suitable XML/XHTML validation library that can be configured for Confluence Storage Format nuances (e.g., custom `ac:` elements).
        2. In `Publisher`, after rendering templates with Handlebars but before calling `client.upsertPage`, pass the rendered XHTML content through the validator.
        3. Report validation errors clearly to the user, indicating the problematic template and line numbers if possible.
        4. Consider basic validation for macro structures generated by helpers (e.g., ensuring `layout-cell` is within `layout-section`).
    - **Relevant Files**: `src/publisher.ts`, `src/macro-helpers.ts`
    - **Reference**: `Confluence.md` for storage format rules.

### 2.3. Option to Publish Without Updating Attachments
    - **Description**: Provide a CLI option or configuration setting to publish page content changes without re-evaluating or re-uploading attachments.
    - **Rationale**: Speeds up updates when only text/template content has changed, not the embedded application assets. This is a TODO item in `README.md`.
    - **Tasks**:
        1. Add a CLI flag (e.g., `--skip-attachments`) or a config option (e.g., `skipAttachments: true` in `publish-confluence.json`).
        2. In `Publisher.processPage`, if this option is active, completely bypass the attachment processing logic (i.e., do not call `getAttachments`, `processLocalFile`, `deleteRemovedAttachments`).
        3. Ensure this interacts correctly with `macroTemplatePath`. If `macroTemplatePath` is null, attachments are already skipped. This option provides explicit control even if a macro template is defined.
    - **Relevant Files**: `src/cli.ts`, `src/publisher.ts`, `src/config.ts`

### 2.4. Improved Progress Reporting for Large Publish Jobs
    - **Description**: Enhance CLI output to provide better feedback during long publishing operations involving multiple pages and attachments.
    - **Rationale**: Improves user experience for large documentation sites or apps with many assets.
    - **Tasks**:
        1. Before starting the publishing process, count the total number of pages to be processed (including child pages).
        2. As each page is processed, log messages like "Processing page X of Y: [Page Title]".
        3. When processing attachments for a page, log messages like "Processing attachments for page '[Page Title]' (Found M local, N remote)".
        4. For individual attachment uploads/updates, log "Uploading attachment A of B: [Filename] to page '[Page Title]'".
        5. Ensure that `logger.info`, `logger.verbose`, and `logger.debug` provide progressively more detail.
    - **Relevant Files**: `src/publisher.ts`, `src/logger.ts`

### 2.5. Configurable Conflict Resolution Strategy for Page Updates
    - **Description**: Allow users to define how to handle conflicts if a Confluence page was modified externally (i.e., its version number increased unexpectedly) since the last known state.
    - **Rationale**: Provides flexibility for different team workflows when collaborative editing occurs directly in Confluence.
    - **Tasks**:
        1. The `client.updatePage` method already requires the current page `version`.
        2. Add a configuration option in `publish-confluence.json` (e.g., `onPageConflict: "overwrite" | "skip" | "fail"`), defaulting to "overwrite".
        3. In `Publisher.upsertPage`, when an existing page is found:
            - The current logic fetches the page, then updates it. The version number is passed to `updatePage`.
            - If Confluence rejects the update due to a version mismatch, this indicates an external modification.
            - Catch this specific error from `client.updatePage`.
            - Based on `onPageConflict`:
                - `overwrite`: Attempt to re-fetch the page to get the latest version number and try the update again (potentially risky if content merged is complex). A safer "overwrite" might just mean "proceed with my content using the latest version number".
                - `skip`: Log a warning and skip updating this specific page.
                - `fail`: Abort the publishing process for this page, or the entire publish run, with a clear error message.
        4. This feature primarily addresses the "version" number aspect of the `updatePage` call. True content merging is outside the scope.
    - **Relevant Files**: `src/publisher.ts`, `src/client.ts`, `src/config.ts`
    - **API Docs**: Confluence API for updating pages requires the next version number.

## III. Testing and Documentation

### 3.1. Update Documentation
    - **Description**: Update `README.md` and any other relevant documentation files (e.g., in the `docs/` directory) to reflect new features, CLI options, and configuration settings.
    - **Rationale**: Keeps users informed about the tool's capabilities and how to use them.
    - **Tasks**:
        1. Document new CLI commands (`preview-render`) and options (`--dry-run`, `--skip-attachments`).
        2. Update the configuration section in `README.md` and `docs/child-pages/page-2.html` for new `publish-confluence.json` settings (e.g., `labels`, `contentProperties`, `onPageConflict`, concurrency settings).
        3. Provide examples for using new features.
        4. Update `docs/child-pages/page-8.html` (Confluence Server API) if new insights about API usage are gained.
    - **Relevant Files**: `README.md`, `docs/`
