<h1>{{pageTitle}}</h1>

{{confluence-toc maxLevel=2}}

{{#confluence-note title="Target Audience"}}
  <p>This page provides a basic overview of the Confluence Storage Format. It's intended for advanced users who want to understand the underlying structure generated by <code>publish-confluence</code> templates or need to troubleshoot rendering issues. For most users, relying on the provided Handlebars helpers is sufficient.</p>
{{/confluence-note}}

<h2>What is Confluence Storage Format?</h2>

<p>Confluence stores the content of pages, blog posts, and comments in an **XHTML-based format**, often referred to simply as "Storage Format". While it uses many standard XHTML tags, it also includes custom XML elements specific to Confluence, particularly for macros (like panels, code blocks, layouts) and other features (like mentions, tasks, emojis).</p>

<p>When you use <code>publish-confluence</code>, the Handlebars templates (`confluence-template.html` and `macro-template.html`) are processed, and the output is generated in this Storage Format before being sent to the Confluence API.</p>

<h2>Key Characteristics</h2>
<ul>
  <li><strong>XHTML-Based:</strong> It heavily relies on XHTML 1.0 syntax (e.g., self-closing tags like <code><br /></code>, lowercase tags and attributes).</li>
  <li><strong>XML Compliance:</strong> The final format must be well-formed XML.</li>
  <li><strong>Custom Elements:</strong> Uses elements in the <code>ac:</code> (Atlassian Confluence) and <code>ri:</code> (Resource Identifier) namespaces for Confluence-specific features.</li>
  <li><strong>Macro Representation:</strong> Confluence macros are represented using the <code><ac:structured-macro></code> element.</li>
</ul>

<h2>Common XHTML Elements Used</h2>
<p>You can use standard XHTML elements within your templates, especially inside macro helper bodies (like panels or layout cells):</p>
<ul>
    <li><code><p>...</p></code>: Paragraphs</li>
    <li><code><h1></code> to <code><h6>...</h6></code>: Headings</li>
    <li><code><ul></code>, <code><ol></code>, <code><li>...</li></code>: Lists</li>
    <li><code><a href="...">...</a></code>: Links (though Confluence often uses <code><ac:link></code> for internal links)</li>
    <li><code><strong>...</strong></code> or <code><b>...</b></code>: Bold text</li>
    <li><code><em>...</em></code> or <code><i>...</i></code>: Emphasis/Italic text</li>
    <li><code><code>...</code></code>: Inline code</li>
    <li><code><br /></code>: Line breaks</li>
    <li><code><hr /></code>: Horizontal rules (or use <code>\{{confluence-divider}}</code>)</li>
    <li><code><table></code>, <code><thead></code>, <code><tbody></code>, <code><tr></code>, <code><th></code>, <code><td>...</td></code>: Tables</li>
    <li><code><pre>...</pre></code>: Preformatted text (often used within code blocks)</li>
</ul>

<h2>Confluence Macro Representation</h2>
<p>The Handlebars helpers provided by <code>publish-confluence</code> (like <code>\{{#confluence-panel}}</code>, <code>\{{#confluence-code}}</code>, etc.) generate the necessary <code><ac:structured-macro></code> elements for you. Understanding the basic structure can be helpful for debugging:</p>

{{#confluence-code language="xml" title="Generic Macro Structure Example"}}
<![CDATA[
<ac:structured-macro ac:name="panel" ac:schema-version="1">
  <ac:parameter ac:name="title">My Panel Title</ac:parameter>
  <ac:parameter ac:name="borderStyle">solid</ac:parameter>
  <ac:rich-text-body>
    <p>This is the content inside the panel.</p>
  </ac:rich-text-body>
</ac:structured-macro>
]]>
{{/confluence-code}}

<ul>
    <li><code>ac:name</code>: Specifies the type of macro (e.g., "panel", "code", "html", "toc").</li>
    <li><code><ac:parameter ac:name="..."></code>: Defines parameters passed to the macro (like title, language, type).</li>
    <li><code><ac:rich-text-body></code>: Contains the main content of the macro, which should itself be valid Storage Format XHTML.</li>
</ul>
<p>The <code>publish-confluence</code> helpers abstract this complexity away, allowing you to write more natural Handlebars templates.</p>

<h2>CDATA Usage</h2>
<p>Sometimes, content needs to be explicitly marked as character data to prevent the XML parser from interpreting it. This is done using <code><![CDATA[...]]></code> sections. You'll most commonly encounter this:</p>
<ul>
    <li>Inside code blocks generated by <code>\{{#confluence-code}}</code> to preserve formatting and special characters.</li>
    <li>Occasionally within macro parameters or link bodies if they contain characters that could conflict with XML parsing.</li>
</ul>
<p>The <code>publish-confluence</code> helpers generally handle CDATA wrapping where necessary (e.g., for the code helper).</p>

<h2>Whitespace Considerations</h2>

{{#confluence-warning title="Important: Avoid Excessive Whitespace"}}
  <p>Confluence renders most block elements (like <code><p></code>) with default margins. Generating unnecessary empty elements (e.g., <code><p></p></code>) or excessive <code><br /></code> tags in your templates can lead to large, unwanted vertical gaps on the rendered Confluence page.</p>
  <p>Follow these tips (as detailed in <code>Confluence.md</code>):</p>
  <ul>
    <li>Avoid empty paragraphs <code><p></p></code>.</li>
    <li>Use <code><br /></code> only for intentional line breaks within a block, not for spacing between blocks.</li>
    <li>Leverage Confluence macros (panels, layouts) for structure instead of multiple <code><p></code> tags.</li>
    <li>Ensure your template logic doesn't generate empty macro bodies (e.g., <code><ac:rich-text-body></ac:rich-text-body></code>).</li>
  </ul>
{{/confluence-warning}}

<h2>Further Reading</h2>
<p>For the most detailed and official information on Confluence Storage Format, refer to the Atlassian Developer Documentation:</p>
<ul>
    <li><a href="https://developer.atlassian.com/server/confluence/confluence-storage-format/">Confluence Storage Format Documentation</a></li>
    <li><a href="https://developer.atlassian.com/server/confluence/confluence-xhtml-storage-format-macros/">Storage Format for Macros</a></li>
</ul>

<hr />
<p><em>Last updated: {{currentDate}}</em></p>